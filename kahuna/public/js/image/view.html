<div class="full-image" ng:controller="ImageCtrl" ng:if="image">

    <div class="top-bar-wrapper">
        <div class="top-bar">
            <div class="top-bar__nav">
                <a class="top-bar__item top-bar__item--first"
                   ui:sref="search.results">← search</a>
                <a class="top-bar__item top-bar__item"
                   ng:if="cropKey"
                   ui:sref="{ crop: null }">← original</a>
            </div>

            <div class="top-bar__items">
                <ui-archiver class="top-bar__item"
                             archived="image.data.userMetadata.data.archived"
                             with-text="true"></ui-archiver>

                <a class="top-bar__item"
                   ng:if="image.data.valid"
                   ui:sref="crop({imageId: image.data.id})">
                    ✂ <span ng:if="cropKey">re</span>crop
                </a>
                <span class="top-bar__item"
                      ng:if="! image.data.valid">cannot crop (missing metadata)</span>
            </div>
        </div>
    </div>

    <div class="image-details">

        <div class="image-info">
            <div class="image-info__group">
                <h2 ng:if="image.data.metadata.title" class="image-info__title">{{image.data.metadata.title}}</h2>

                <div class="small-margin-bottom">{{image.data.metadata.description}}</div>
            </div>

            <div class="image-info__group">
                <div ng:if="image.data.metadata.dateTaken"
                     class="metadata-line">
                    on
                    <span class="metadata-line__info">
                        {{image.data.metadata.dateTaken | date:'d MMM yyyy, HH:mm'}}
                    </span>
                </div>

                <div ng:if="image.data.metadata.byline || image.data.metadata.credit"
                     class="metadata-line">
                    by
                    <span class="metadata-line__info" ng:show="image.data.metadata.byline">
                        <a ui:sref="search.results({query: image.data.metadata.byline})">{{image.data.metadata.byline}}</a>
                    </span>
                    <span class="metadata-line__info" ng:hide="image.data.metadata.byline">
                        unknown
                    </span>
                    /
                    <span class="metadata-line__info">
                        <a ui:sref="search.results({query: image.data.metadata.credit})">{{image.data.metadata.credit}}</a>
                    </span>
                </div>

                <div ng:if="image.data.metadata.subLocation || image.data.metadata.city || image.data.metadata.state || image.data.metadata.country"
                     class="metadata-line">
                    in
                    <span ng:repeat="prop in ['subLocation', 'city', 'state', 'country']" ng:if="image.data.metadata[prop]">
                        <span class="metadata-line__info">
                            <a ui:sref="search.results({query: image.data.metadata[prop]})">{{image.data.metadata[prop]}}</a><!-- no whitespace before comma
                        --></span><span ng:if="! $last">,</span>
                    </span>
                </div>

                <div ng:if="image.data.metadata.copyright"
                     class="metadata-line">
                    ©
                    <span class="metadata-line__info">
                        <a ui:sref="search.results({query: image.data.metadata.copyright})">{{image.data.metadata.copyright}}</a>
                    </span>
                    <!-- FIXME: do we want copyright or copyrightNotice? -->
                </div>

                <div class="metadata-line">
                    uploaded
                    <span class="metadata-line__info">
                        {{image.data.uploadTime | date:'d MMM yyyy, HH:mm'}}
                    </span>
                    <span class="metadata-line__info">
                        (<a ui:sref="search.results({uploadedBy: image.data.uploadedBy})">{{image.data.uploadedBy | stripEmailDomain}}</a>)
                    </span>
                </div>

            </div>

            <!-- FIXME: iff has useful metadata -->
            <div class="image-info__group">
                <button class="metadata-reveal"
                        ng:click="metadataExpanded = !metadataExpanded">
                    <span ng:hide="metadataExpanded">▸ Show</span>
                    <span ng:show="metadataExpanded">▾ Hide</span>
                    full metadata
                </button>

                <table ng:show="metadataExpanded" class="metadata">
                    <tbody class="metadata__body">
                        <tr ng:repeat="(key, value) in image.data.metadata" ng:if="isUsefulMetadata(key)">
                            <th class="metadata__key">{{key}}</th>
                            <td>{{value}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <dl class="image-info">
            <dt class="image-info__heading image-info__heading--first">Labels</dt>
            <dd>
                <ui-labeller labels="image.data.userMetadata.data.labels">
                </ui-labeller>
            </dd>
        </dl>


        <div class="image-info">
            <dl class="image-info__group" ng:if="crops.length > 0">
                <dt class="image-info__heading">Crops <span ng:if="cropKey">(<a ui:sref="{ crop: null }">original</a>)</span></dt>
                <dd>
                    <ul class="image-crops">
                        <li class="image-crop"
                            ng:class="{'image-crop--selected': crop.id == cropKey}"
                            ng:repeat="crop in crops">
                            <a draggable="true"
                               ng:init="extremeAssets = (crop | getExtremeAssets)"
                               ng:click="ctrl"
                               ui:sref="{crop: crop.id}"
                               ui:drag-data="{{imageSync | asImageAndCropsDragData:crop}}"
                               ui:drag-image="{{extremeAssets.smallest | assetFile}}">
                                <img class="image-crop__image" ng:src="{{extremeAssets.smallest | assetFile}}" />
                            </a>
                            <div class="image-crop__aspect-ratio">{{crop.specification.aspectRatio | asAspectRatioWord}}</div>
                        </li>
                    </ul>
                </dd>
            </dl>

            <dl class="image-info__group" ng:if="image.data.metadata.keywords.length > 0">
                <dt class="image-info__heading">Keywords</dt>
                <dd>
                    <ul>
                        <li class="image-info__keyword"
                            ng:repeat="keyword in image.data.metadata.keywords track by $index">
                            <a ui:sref="search.results({query: keyword})">
                                {{keyword}}
                            </a>
                        </li>
                    </ul>
                </dd>
            </dl>
        </div>
    </div>

    <div class="image-holder">
        <div class="easel">
            <div class="easel__canvas" ng:if="!cropKey">
                <img class="easel__image"
                     ng:src="{{image.data.source | assetFile}}"
                     ui:drag-data="{{imageSync | asImageDragData}}" />
            </div>


            <!-- TODO: As this loads async, add a loader -->
            <div class="easel__canvas" ng:if="cropKey">
                <a draggable="true"
                   class="easel__image-container"
                   ng:if="crop"
                   ng:init="extremeAssets = (crop | getExtremeAssets)"
                   ui:sref="{crop: cropKey}"
                   ui:drag-data="{{imageSync | asImageAndCropsDragData:crop}}"
                   ui:drag-image="{{extremeAssets.smallest | assetFile}}">
                    <img class="easel__image" ng:src="{{extremeAssets.largest | assetFile}}" />
                </a>
            </div>
        </div>
    </div>
</div>
