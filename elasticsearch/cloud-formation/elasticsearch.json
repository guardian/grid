{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Media Service Elasticsearch",
    "Parameters": {
        "KeyName": {
            "Description": "The EC2 Key Pair to allow SSH access to the instance",
            "Type": "String",
            "Default": "digital-cms-team"
        },
        "Stage": {
            "Description": "Environment name",
            "Type": "String",
            "AllowedValues": ["PROD"],
            "Default": "PROD"
        }
    },
    "Resources": {
        "Group": {
            "Type": "AWS::IAM::Group",
            "Properties": {
                "Policies": [{
                    "PolicyName": "elasticsearch-group-policy",
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [{
                            "Effect": "Allow",
                            "Action": "ec2:DescribeInstances",
                            "Resource": "*"
                        }]
                    }
                }]
            }
        },
        "User": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "Path": "/",
                "Groups": [ { "Ref": "Group" } ]
            }
        },
        "HostKeys": {
            "Type": "AWS::IAM::AccessKey",
            "Properties": {
                "UserName": { "Ref": "User" }
            }
        },
        "AutoscalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AvailabilityZones": { "Fn::GetAZs": "" },
                "LaunchConfigurationName": { "Ref": "LaunchConfig" },
                "MinSize": "2",
                "MaxSize": "4",
                "DesiredCapacity": "2",
                "HealthCheckType": "EC2",
                "HealthCheckGracePeriod": 180,
                "LoadBalancerNames": [ ],
                "Tags": [
                    {
                        "Key": "Stage",
                        "Value": { "Ref": "Stage" },
                        "PropagateAtLaunch": "true"
                    },
                    {
                        "Key": "Role",
                        "Value": "media-service-elasticsearch",
                        "PropagateAtLaunch": "true"
                    }
                ]
            }
        },
        "LaunchConfig": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "KeyName": { "Ref": "KeyName" },
                "ImageId": "ami-eecd2899",
                "SecurityGroups": [ { "Ref": "SecurityGroup" } ],
                "InstanceType": "m1.large",
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":["", [
                            "#!/bin/bash -ev\n",

                            "adduser --disabled-password --system --group media-service\n",
                            "cp -r ~/.ssh /home/media-service/\n",

                            "mkdir /data\n",
                            "mount /dev/xvdb /data\n",

                            "apt-get -y update\n",
                            "apt-get -y install language-pack-en openjdk-7-jre-headless\n",

                            "cd /home/media-service\n",

                            "wget https://s3-eu-west-1.amazonaws.com/media-service-dist/", { "Ref" : "Stage" },
                            "/media-service-elasticsearch/elasticsearch.tar.gz\n",

                            "tar xf elasticsearch.tar.gz\n",

                            "sed -i \\\n",
                            "    -e 's,@@REGION,", { "Ref": "AWS::Region" }, ",g' \\\n",
                            "    -e 's,@@STAGE,", { "Ref": "Stage" }, ",g' \\\n",
                            "    -e 's,@@ROLE,media-service-elasticsearch,g' \\\n",
                            "    -e 's,@@ACCESS_KEY,", { "Ref": "HostKeys" }, ",g' \\\n",
                            "    -e 's,@@SECRET_KEY,", { "Fn::GetAtt": [ "HostKeys", "SecretAccessKey" ] }, ",g' \\\n",
                            "    elasticsearch/config/elasticsearch.yml\n",

                            "chown -R media-service /home/media-service /data\n",
                            "chgrp -R media-service /home/media-service /data\n",

                            "mv elasticsearch/elasticsearch.conf /etc/init/\n",

                            "start elasticsearch\n"
                        ]]
                    }
                }
            }
        },
        "SecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "SSH and Elasticsearch",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "9200",
                        "ToPort": "9200",
                        "CidrIp": "77.91.248.0/21"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "9300",
                        "ToPort": "9300",
                        "CidrIp": "77.91.248.0/21"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "SecurityGroupIngress": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupName": { "Ref": "SecurityGroup" },
                "IpProtocol": "tcp",
                "FromPort": 0,
                "ToPort": 65535,
                "SourceSecurityGroupName": { "Ref": "SecurityGroup" }
            }
        }
    }
}
