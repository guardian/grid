name: Grid CI
on: [pull_request]
jobs:
  JSBuild:
    runs-on: ubuntu-20.04
    permissions:
      # Allow GitHub to request an OIDC JWT ID token, for exchange with `aws-actions/configure-aws-credentials`
      # See https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#updating-your-github-actions-workflow
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
      - name: Kahuna
        working-directory: ./kahuna
        run: |
          npm ci
          npm test
      - name: Image Counter Lambda
        working-directory: ./image-counter-lambda
        run: |
          npm ci
          npm test
      - name: S3Watcher
        working-directory: ./s3watcher/lambda
        run: |
          npm ci
          npm run build
      - name: CDK (Infra)
        working-directory: ./cdk
        run: |
          yarn install
          yarn test
          yarn synth
      #- name: Reaper
      #  working-directory: ./reaper
      #  run: |
      #    npm install
      #    npm run riffraff-artefact
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.GU_RIFF_RAFF_ROLE_ARN }}
          aws-region: eu-west-1
      - name: Upload 'grid-extras' to Riff-Raff
        uses: guardian/actions-riff-raff@v2
        with:
          app: editorial-wires
          projectName: 'media-service::grid::extras'
          configPath: cdk/cdk.out/riff-raff.yaml
          contentDirectories: |
            cdk.out:
              - cdk/cdk.out

  ScalaBuild:
    runs-on: ubuntu-20.04
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.16.2
        # Wait for elasticsearch to report healthy before continuing.
        # see https://github.com/actions/example-services/blob/master/.github/workflows/postgres-service.yml#L28
        options: -e "discovery.type=single-node" --expose 9200 --health-cmd "curl localhost:9200/_cluster/health" --health-interval 10s --health-timeout 5s --health-retries 10
      localstack:
        image: localstack/localstack:0.11.0
        env:
          SERVICES: kinesis,dynamodb
          DEFAULT_REGION: eu-west-1
          KINESIS_ERROR_PROBABILITY: 0.0
          PORT_WEB_UI: 5050
        ports:
          - 5050:5050
          - 4566:4566
        options: >-
          --health-cmd "curl localhost:5050/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
    - uses: actions/checkout@v3.5.0
    - name: SBT
      uses: ./.github/actions/sbt
      env:
        USE_DOCKER_FOR_TESTS: false
        ES6_TEST_URL: http://elasticsearch:9200
        LOCALSTACK_ENDPOINT: http://localstack:4566
      with:
        args: clean compile test:compile test
